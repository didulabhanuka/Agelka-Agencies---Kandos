name: üöÄ Deploy Agelka ERP to Azure

on:
  push:
    branches: [main]
  workflow_dispatch: # allows manual trigger from GitHub UI

env:
  ACR_REGISTRY: agelkaacr.azurecr.io
  BACKEND_IMAGE: agelka-server
  FRONTEND_IMAGE: agelka-client
  RESOURCE_GROUP: agelka-rg
  CONTAINER_ENV: agelka-env

jobs:
  # ‚îÄ‚îÄ Job 1: Build & Push Docker Images ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build:
    name: üê≥ Build & Push Images
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üîê Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: üèóÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üî® Build & Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          dockerfile: ./server/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest
            ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest
          cache-to: type=inline

      - name: üé® Build & Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          dockerfile: ./client/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest
          cache-to: type=inline

  # ‚îÄ‚îÄ Job 2: Deploy to Azure Container Apps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy:
    name: ‚òÅÔ∏è Deploy to Azure
    runs-on: ubuntu-latest
    needs: build # only runs after build succeeds

    steps:
      - name: üîê Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üöÄ Deploy Backend to Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.CONTAINER_ENV }}
          containerAppName: agelka-server
          imageToDeploy: ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          registryUrl: ${{ env.ACR_REGISTRY }}
          registryUsername: ${{ secrets.ACR_USERNAME }}
          registryPassword: ${{ secrets.ACR_PASSWORD }}
          targetPort: 5000
          ingress: external
          environmentVariables: >
            NODE_ENV=production
            PORT=5000
            MONGO_URL=secretref:mongo-url
            JWT_SECRET=secretref:jwt-secret
            JWT_EXPIRES=${{ secrets.JWT_EXPIRES }}
            CLIENT_ORIGIN=${{ secrets.CLIENT_ORIGIN }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            ADMIN_PASSWORD=secretref:admin-password
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=secretref:smtp-pass
            SMTP_SECURE=${{ secrets.SMTP_SECURE }}
            INQUIRY_TO_EMAIL=${{ secrets.INQUIRY_TO_EMAIL }}

      - name: üé® Deploy Frontend to Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.CONTAINER_ENV }}
          containerAppName: agelka-client
          imageToDeploy: ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          registryUrl: ${{ env.ACR_REGISTRY }}
          registryUsername: ${{ secrets.ACR_USERNAME }}
          registryPassword: ${{ secrets.ACR_PASSWORD }}
          targetPort: 80
          ingress: external

      - name: ‚úÖ Deployment Complete
        run: |
          echo "üéâ Agelka ERP deployed successfully!"
          echo "üïê Deployed at: $(date)"
          echo "üì¶ Image SHA: ${{ github.sha }}"